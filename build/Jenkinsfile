pipeline {
    agent any 
    environment {
        AWS_REGION="eu-central-1"
        EKS_ADMIN_ROLE="udacity-eks-admin-role"
        EKS_PROFILE_NAME="udacity-eks"
        CFN_STACK_NAME="udacity-eks-roles-and-permissions"
    }
    stages {
        stage('prepare aws iam') {
            steps {
                withAWS(credentials: 'aws-creds', region: 'eu-central-1') {
                    sh 'cd scripts && ./prepare-iam.sh ${EKS_ADMIN_ROLE} ${EKS_PROFILE_NAME}'
                }
            }
        }
        stage('install udacity eks cluster') {
            steps {
                sh '''
                ./scripts/assume-role.sh $CFN_STACK_NAME
                
                aws sts get-caller-identity
                
                export LC_CTYPE=en_US.UTF-8
                curl --silent --location https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz | tar xz -C .
                mv eksctl $HOME/bin && export PATH=$PATH:$HOME/bin
                eksctl version
                
                wget -cO - https://github.com/vmware-tanzu/carvel-ytt/releases/download/v0.30.0/ytt-linux-amd64 > ytt
                chmod +x ./ytt
                mv ytt $HOME/bin
                ytt version
                
                ytt -f . > cluster-ytt.yaml
                cat cluster-ytt.yaml
                
                eksctl create cluster -f cluster-ytt.yaml
                '''
            }
        }
        stage('update eks config') {
            steps {
                sh './scripts/assume-role.sh $CFN_STACK_NAME'
                sh 'aws sts get-caller-identity'
                sh 'aws eks update-kubeconfig --name udacity-cluster --profile ${EKS_PROFILE_NAME}'
            }
        }        
    }
}